<!DOCTYPE html>
<html>
<head>
		<meta http-equiv="content-type" content="text/html" charset="ISO-8859-1">
		<!-- Optimizing for mobile -->
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
		
		<title>The Gallery</title>
		<link rel="stylesheet" type="text/css" href="./css/main.css" media="screen" />
		<script src="js/three.min.js"></script>
		<script src="js/Detector.js"></script> 
		<script src="js/ColladaLoader.js"></script>
		<script src="js/PointerLockControls.js"></script>
</head>


<body>

<div id="blocker">
	<div id="instructions">
		<span> Click to Play </span>
		<p> W,A,S,D or arrow keys = Move around, Mouse = Look around, Spacebar = Jump. </p>
	</div>
</div>

<script>
	var render;
	var controls;
	//blocker displays the controls, and tells user to click on the screen to play
	var blocker = document.getElementById('blocker');
	var instructions = document.getElementById('instructions');

	//check to make sure we have pointerLock capability in users browser
	var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

	if(havePointerLock) {
		var element = document.body;
		var pointerlockchange = function( event ) {
			if(document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {
				controls.enabled = true;
				blocker.style.display = 'none';
			} else {
				controls.enabled = false;

				blocker.style.display = '-webkit-box';
				blocker.style.display = '-moz-box';
				blocker.style.display = 'box';

				instructions.style.display = '';
			}		
		}
		var pointerlockerror = function(event) { //event refers to any actions done by keyboard or mouse.
			instructions.style.display = '';
		}
		
		//adding listeners for the pointer lock change and for pointer lock error
		document.addEventListener('pointerlockchange', pointerlockchange, false);
		document.addEventListener('mozpointerlockchange', pointerlockchange, false);
		document.addEventListener('webkitpointerlockchange',pointerlockchange, false);

		document.addEventListener('pointerlockerror',pointerlockerror, false);
		document.addEventListener('mozpointerlockerror',pointerlockerror, false);
		document.addEventListener('webkitpointerlockerror',pointerlockerror, false);

		//clicking on the screen should result in controls getting activated and blocker becoming hidden
		instructions.addEventListener('click',function(event) {
			instructions.style.display = 'none';
			blocker.style.display = 'none';
			
			//asking browser to lock browser
			element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

			if ( /Firefox/i.test( navigator.userAgent ) ) {

				var fullscreenchange = function ( event ) {

					if ( document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element ) {

						document.removeEventListener( 'fullscreenchange', fullscreenchange );
						document.removeEventListener( 'mozfullscreenchange', fullscreenchange );

						element.requestPointerLock();
					}			

				}
				//disables automatic transition to full screen, a default of disabling browser(???)
				document.addEventListener( 'fullscreenchange', fullscreenchange, false );
				document.addEventListener( 'mozfullscreenchange', fullscreenchange, false );

				element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

				element.requestFullscreen();

			} else {

				element.requestPointerLock();

			}

		}, false );

		} else {instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API'; }

if(!(Detector.webgl)) //if no support for WebGL
{
	alert("Your browser does not support WebGL :(");
}
else {
var scene = new THREE.Scene();

var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

var objects = [];

controls = new THREE.PointerLockControls(camera);
scene.add(controls.getObject());

var raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0), 0, 10);


//Change the size of the canvas if resized
window.addEventListener('resize', function() {
var WIDTH = window.innerWidth,
HEIGHT = window.innerHeight;
renderer.setSize(WIDTH, HEIGHT);
camera.aspect = WIDTH / HEIGHT;
camera.updateProjectionMatrix();
});


var renderer = new THREE.WebGLRenderer({antialias:false}); //antialias set to true if not taxing
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor( 0xffffff, 1); //background color
document.body.appendChild(renderer.domElement);

//Akin to sun, lights the whole world
var topLight = new THREE.DirectionalLight(0xdddddd, 1.0);
topLight.position.y = 15;
topLight.position.z = 15;
scene.add(topLight);

var cameraLight = new THREE.DirectionalLight(0xdddddd,1.0);
cameraLight.position.z = camera.position.z;
cameraLight.position.y = camera.position.y + 3;
cameraLight.position.x = camera.position.x;
scene.add(cameraLight);



//THIS UPLOADS YOUR PHOTOS. 

var num_of_paintings = 30;
var paintings = [];
for(var i = 0; i < num_of_paintings-1; i++){
	(function(i) {
		var artwork = new Image();
		var ratiow = 0;
		var ratioh = 0;

		artwork.onload = function(){

		ratiow = artwork.width / artwork.width;
		ratioh = artwork.height / artwork.width;
		// plane for artwork
		var plane = new THREE.Mesh(new THREE.PlaneGeometry(ratiow, ratioh),img); //width, height
		plane.overdraw = true;
		if(i <= Math.floor(num_of_paintings/2))
		{
			plane.position.set(2*i - 2*Math.floor(num_of_paintings/4), 1 , 0);
		}
		else
		{
		plane.position.set(2*i - num_of_paintings - Math.floor(num_of_paintings/2), 1, 5);
		plane.rotation.y = Math.PI;
		}

		scene.add(plane);
		objects.push(plane);
		}
		var source = './img/Artworks/' + (i+1).toString() + '.jpg';
		console.log(source);
		artwork.src = source;
		var img = new THREE.MeshBasicMaterial({ //CHANGED to MeshBasicMaterial
		map:THREE.ImageUtils.loadTexture(artwork.src)
		});

		img.map.needsUpdate = true; //ADDED
	}(i))
}
//SPECIAL THANKS TO MATT CONDON FOR HELPING ME OUT WITH THE ABOVE CODE HE IS A LIFE SAVER. MUCH LOVEEEEEEEEEEE.



// FLOOR
var floorTexture = new THREE.ImageUtils.loadTexture( 'img/MarbleFloor1.jpg' );
floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
floorTexture.repeat.set( 10, 10 );
var floorMaterial = new THREE.MeshBasicMaterial( { map: floorTexture, side: THREE.DoubleSide } );
var floorGeometry = new THREE.PlaneGeometry(1000, 1000, 1, 1);
var floor = new THREE.Mesh(floorGeometry, floorMaterial);
floor.position.y = -0.5;
floor.rotation.x = Math.PI / 2;
scene.add(floor);


var render = function () {
requestAnimationFrame(render); 
controls.isOnObject(false);
raycaster.ray.origin.copy(controls.getObject().position);
raycaster.ray.origin.y -= 10;

var intersections = raycaster.intersectObject(objects);
if(intersections.length > 0) {
	controls.isOnObject(true);
}

controls.update();

renderer.render(scene, camera);
};

render();
}
</script>
</body>
</html>
